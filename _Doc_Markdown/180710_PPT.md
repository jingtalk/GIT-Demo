# PPT大纲

时间：2018年7月9日

## 1. 上半年工作要点 

一. [I](http://www.cnblogs.com/lidabo/archive/2013/09/04/3300327.html)[TOP std::string 库跨线程](http://www.cnblogs.com/lidabo/archive/2013/09/04/3300327.html)：

问题：

STL使用模板生成，当我们使用模板的时候，每一个EXE，和DLL都在编译器产生了自己的代码，导致模板所使用的静态成员不同步，所以出现数据传递的各种问题。

比如 apollo 包了ITOP sdk，游戏接入 apollo，然后发现 apollo 封装不完整，就直接调用了 ITOP 的接口，这个时候就有跨 so 的问题。

解决方案或者功能：

封装一个中间层ITOPString，管理 std::string 模板类资源的分配与释放，具体实现就是将游戏传入的模板string中的值，在SDK内部新建一个中间层buffer，所以与游戏的交互数据进出，都晨buffer中进行，屏蔽了不同版本STL模板的差异；

二. ITOP Logger 日志模块：

 问题：

iOS、Android 都需要日志模块

日志 crash 要实时落地或者上报，游戏在 crash 的时候，能获取到上下文信息；

日志上传问题；

日志开关及过滤；

日志级别；

日志压缩、加密；

解决方案或者功能：

ITOP 1.0 版本是 Android、iOS 各自使用java、oc开发一套，因为功能点和需求一致，相当于写了两套，重复工作很多，于是选型C++/C开发；

Mars/xlog 模块满足选型要求，主要是剥离了其中的mmap实现，实现日志文件实时映射，且只有一个copy过程，执行效率高；

日志格式化并实时写入文件，每4M大小写一个文件，超过40M会依次删除老日志文件；添加控制台开关，只写入重新日志到文件，其它打印到控制台；

日志级别开关定制，初始化阶段通过云端配置下发日志级别，按级别打印日志；

日志逐条加密并压缩；

离线日志上传，队列管理，线程池管理；

三. ITOP WebView 改造实现：

问题：

游戏侧运营活动，客服系统都会使用到 webview，系统 webview 有很多兼容性问题，特别是视频播放；

国内使用 tbs x5内核，国外 tbs x5 内核审查较严，而且 x5 内核内部有一些自己的逻辑，会请求 tbs 服务器（国内），有审查问题；

tbs 内核不支持 youtube 播放，国内的QQ浏览器有同样的问题，但游戏侧的运营视频很多是托管在youtube上面

tbs 提供了 x5内核跟系统内核切换，但是切换的系统内核是 tbs 修改过的，此处引入了一些bug；

 解决方案或者功能：

剥离 webview 中ui逻辑，将内核代码抽象提取，内核切换（x5、系统），实现切换（tbs实现，系统实现、或者其它三方实现）都是通过云端配置下发，插件形式实现。对于 youtube 视频支持不好的地区，配置下发切到其它 webview 实现；

四. ITOP jni 数据转换：

问题：

 JNI c到java，java到c 操作中会有有大量的 struct2jni/jni2struct 操作，针对java中的每一个类，jni中都需要一对一的查看field并进行查找转换，重复工作太多，影响效率；

解决方案或者功能、优化：

使用C++模板实现 jobject 与 java struct 的盲转，提高开发效率

 